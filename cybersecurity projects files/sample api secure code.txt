from flask import Flask, request, jsonify
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address
import os

app = Flask(__name__)

# Rate limiting (protect against abuse / DoS)
limiter = Limiter(
    get_remote_address,
    app=app,
    default_limits=["5 per minute"]
)

# Store API keys securely (environment variables)
API_KEYS = {
    "admin-key-123": "admin",
    "user-key-456": "user"
}

def authenticate():
    api_key = request.headers.get("X-API-KEY")

    if not api_key or api_key not in API_KEYS:
        return None
    
    return API_KEYS[api_key]


@app.route("/data", methods=["GET"])
@limiter.limit("5 per minute")
def get_data():
    role = authenticate()

    if not role:
        return jsonify({"error": "Unauthorized"}), 401

    return jsonify({
        "message": "Secure data accessed",
        "role": role
    })


@app.route("/admin", methods=["POST"])
def admin_action():
    role = authenticate()

    if role != "admin":
        return jsonify({"error": "Forbidden: Admins only"}), 403

    data = request.json

    # Input validation
    if not data or "task" not in data:
        return jsonify({"error": "Invalid input"}), 400

    return jsonify({
        "status": "Admin task completed",
        "task": data["task"]
    })


# Secure headers
@app.after_request
def set_secure_headers(response):
    response.headers["X-Content-Type-Options"] = "nosniff"
    response.headers["X-Frame-Options"] = "DENY"
    response.headers["Content-Security-Policy"] = "default-src 'self'"
    return response


if __name__ == "__main__":
    app.run(debug=False)
